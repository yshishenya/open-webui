{
  "spec_id": "yandex-oauth-login-2026-02-05-1722",
  "title": "yandex-oauth-login",
  "generated": "2026-02-05T14:22:38.324414Z",
  "last_updated": "2026-02-05T15:17:39.511523Z",
  "metadata": {
    "template": "medium",
    "complexity": "medium",
    "risk_level": "medium",
    "estimated_hours": 24,
    "security_sensitive": false,
    "default_category": "implementation",
    "title": "Yandex OAuth login",
    "status": "active",
    "activated_date": "2026-02-05T14:45:35.803465Z"
  },
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "yandex-oauth-login",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3"
      ],
      "total_tasks": 8,
      "completed_tasks": 7,
      "metadata": {}
    },
    "phase-1": {
      "type": "phase",
      "title": "Phase 1: [To Be Defined]",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2"
      ],
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "title": "Phase 1: API hooks for existing frontend URLs",
        "needs_journaling": true,
        "completed_at": "2026-02-05T15:14:56.444815Z"
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Phase 2: [To Be Defined]",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3"
      ],
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "needs_journaling": true,
        "completed_at": "2026-02-05T15:14:57.145124Z"
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Phase 3: [To Be Defined]",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3"
      ],
      "total_tasks": 3,
      "completed_tasks": 2,
      "metadata": {}
    },
    "task-1-1": {
      "type": "task",
      "title": "Add /api/v1/oauth/yandex login + callback endpoints",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 2.0,
        "file_path": "backend/open_webui/routers/oauth_russian.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:56.203471Z",
        "needs_journaling": true,
        "status_note": "Added /api/v1/oauth/yandex/login + /callback thin hooks delegating to OAuthManager."
      },
      "description": "Add thin GET hooks in backend/open_webui/routers/oauth_russian.py for /oauth/yandex/login and /oauth/yandex/callback that delegate to request.app.state.oauth_manager.handle_login/handle_callback with provider='yandex'."
    },
    "task-1-2": {
      "type": "task",
      "title": "Add router tests for /api/v1/oauth/yandex hooks",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 2.0,
        "file_path": "backend/open_webui/test/apps/webui/routers/test_oauth_yandex.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:56.444572Z",
        "needs_journaling": true,
        "status_note": "Added delegation tests for yandex OAuth endpoints."
      },
      "description": "Add a FastAPI TestClient integration test that verifies the yandex login/callback endpoints delegate to app.state.oauth_manager (monkeypatched), without calling external Yandex endpoints."
    },
    "task-2-1": {
      "type": "task",
      "title": "Add Yandex userinfo normalization helper",
      "status": "completed",
      "parent": "phase-2",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 2.0,
        "file_path": "backend/open_webui/utils/airis/oauth_yandex.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:56.678802Z",
        "needs_journaling": true,
        "status_note": "Added normalize_yandex_userinfo helper in utils/airis."
      },
      "description": "Create backend/open_webui/utils/airis/oauth_yandex.py with a typed helper to normalize Yandex userinfo into standard keys (email/name/picture) used by OAuthManager."
    },
    "task-2-2": {
      "type": "task",
      "title": "Normalize Yandex claims in OAuthManager callback",
      "status": "completed",
      "parent": "phase-2",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 2.0,
        "file_path": "backend/open_webui/utils/oauth.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:56.912141Z",
        "needs_journaling": true,
        "status_note": "Integrated Yandex userinfo normalization into OAuthManager callback."
      },
      "description": "Update backend/open_webui/utils/oauth.py so that when provider == 'yandex' the userinfo payload is normalized (email/name/picture) before standard OAuthManager extraction and account merge/signup logic."
    },
    "task-2-3": {
      "type": "task",
      "title": "Set Yandex sub_claim to 'id'",
      "status": "completed",
      "parent": "phase-2",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 1.0,
        "file_path": "backend/open_webui/config.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:57.144882Z",
        "needs_journaling": true,
        "status_note": "Configured yandex provider sub_claim='id' in OAUTH_PROVIDERS."
      },
      "description": "Update backend/open_webui/config.py so OAUTH_PROVIDERS['yandex'] uses sub_claim='id' (stable Yandex user id) for Users.oauth.yandex.sub."
    },
    "task-3-1": {
      "type": "task",
      "title": "Add unit tests for Yandex userinfo normalization",
      "status": "completed",
      "parent": "phase-3",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 2.0,
        "file_path": "backend/open_webui/test/apps/webui/utils/test_oauth_yandex_normalization.py",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:14:57.375355Z",
        "needs_journaling": true,
        "status_note": "Added unit tests for Yandex userinfo normalization."
      },
      "description": "Add pytest coverage for normalize_yandex_userinfo(): email extraction (default_email/emails[0]), name selection precedence, and picture URL generation."
    },
    "task-3-2": {
      "type": "task",
      "title": "Update docs for Yandex OAuth redirect URI + endpoints",
      "status": "completed",
      "parent": "phase-3",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "estimated_hours": 1.0,
        "file_path": "README-B2C-IMPLEMENTATION.md",
        "task_category": "implementation",
        "completed_at": "2026-02-05T15:15:32.480906Z",
        "needs_journaling": true,
        "status_note": "Updated README-B2C to include YANDEX_OAUTH_SCOPE and strict redirect URI note."
      },
      "description": "Update README-B2C-IMPLEMENTATION.md (and/or .qoder/RUSSIAN_OAUTH_SETUP.md if needed) to reflect the actual Yandex OAuth endpoints and the strict Redirect URI matching requirement."
    },
    "task-3-3": {
      "type": "verify",
      "title": "Manual smoke test: Yandex OAuth login",
      "status": "blocked",
      "parent": "phase-3",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "estimated_hours": 1.0,
        "task_category": "implementation",
        "verification_type": "manual",
        "expected": "Redirects to Yandex authorize, then back to /auth with token cookie set (not HttpOnly) and user logged in.",
        "command": "Set YANDEX_CLIENT_ID/YANDEX_CLIENT_SECRET and YANDEX_REDIRECT_URI=https://<domain>/api/v1/oauth/yandex/callback, restart, then open /auth and click 'Continue with Yandex'.",
        "status_note": "Awaiting Yandex OAuth env config (YANDEX_CLIENT_ID/SECRET/REDIRECT_URI/OAUTH_SCOPE) to run manual smoke test."
      },
      "description": "With YANDEX_CLIENT_ID/SECRET set, open /auth and click 'Continue with Yandex'. Verify redirect to Yandex authorize, then callback to /auth sets token cookie (not HttpOnly) and user is logged in. Verify missing email is handled safely (no user created)."
    }
  }
}