# Telegram Authentication (Telegram Login Widget)

This document explains how to enable and operate **Telegram Login Widget** authentication in Open WebUI, including account **sign-in**, optional **sign-up**, and **link/unlink** flows for existing users.

## TL;DR

1. Create a bot via **@BotFather** and get the **bot token**.
2. Set the bot's **Login Widget domain** (BotFather → `/setdomain`) to your WebUI domain.
3. Configure env vars (see below) and restart the backend.
4. Users can **link** Telegram from **Settings → Account**. Sign-in requires a linked account by default.

## Configuration

Telegram auth is controlled by the following environment variables (see `.env.example`):

- `ENABLE_TELEGRAM_AUTH` (`true|false`) — master switch.
- `TELEGRAM_BOT_USERNAME` — bot username (with or without leading `@`).
- `TELEGRAM_BOT_TOKEN` — **secret** bot token from BotFather (**do not commit**).
- `TELEGRAM_AUTH_MAX_AGE_SECONDS` — max allowed age of `auth_date` (default: `600`).
- `ENABLE_TELEGRAM_SIGNUP` (`true|false`) — allow creating new users via Telegram.

The public config endpoint (`GET /api/config`) exposes only:
- `telegram.enabled` — computed server-side (enabled + bot username + bot token present).
- `telegram.bot_username` — sanitized (trimmed, leading `@` removed).

No secrets are returned to clients.

## Bot setup (BotFather)

1. Open **@BotFather** in Telegram.
2. Create a bot with `/newbot`.
3. Copy the **bot token** and set it as `TELEGRAM_BOT_TOKEN`.
4. Configure the **Login Widget domain**:
   - Use BotFather command `/setdomain` (select your bot).
   - Set it to the **domain where users open your WebUI** (e.g. `chat.example.com`).
   - Use the exact production hostname (and port, if applicable) your users access.

After changes, restart the backend so it picks up the new config.

## User flows

### 1) Sign in (default)

Endpoint: `POST /api/v1/auths/telegram/signin`

- **Does not** auto-create users.
- If the Telegram account is **not linked** to an existing user, the API responds with:
  - `409` and `detail="NOT_LINKED"`
- The intended UX is:
  1. User signs in with their existing method (password / OAuth / SSO).
  2. User links Telegram from **Settings → Account**.
  3. Next time they can sign in via Telegram.

This avoids accidental account duplication and keeps multi-provider auth consistent.

### 2) Sign up (optional, gated)

Endpoint: `POST /api/v1/auths/telegram/signup`

- Only available when `ENABLE_TELEGRAM_SIGNUP=true`.
- If disabled, the API responds with:
  - `403` and `detail="SIGNUP_DISABLED"`
- Requires legal acceptance flags in the request body:
  - `terms_accepted=true`
  - `privacy_accepted=true`
  - If missing, the API responds with:
    - `400` and `detail="You must accept the terms and privacy policy"`
- New users get a deterministic placeholder email:
  - `telegram@<telegram_id>.local`

Recommended: keep Telegram sign-up **disabled** in production unless you explicitly want open registration.

### 3) Link Telegram to an existing account (recommended)

Endpoint: `POST /api/v1/auths/telegram/link` (requires auth)

- Stores Telegram identity under `user.oauth.telegram.sub` (`sub = telegram_id`).
- Enforces uniqueness: one Telegram account can only be linked to one Open WebUI user.
- If already linked to another user, the API responds with:
  - `409` and `detail="TELEGRAM_ALREADY_LINKED"`

### 4) Unlink Telegram

Endpoint: `DELETE /api/v1/auths/telegram/link` (requires auth)

- Removes the `telegram` entry from `user.oauth`.
- After unlinking, Telegram sign-in will return `NOT_LINKED` again.

## Security model (how breakage is prevented)

Telegram widget payload is validated server-side:

- **Signature verification** using Telegram's HMAC scheme.
  - Secret key is derived from the bot token (SHA-256) per Telegram Login docs.
  - Comparison uses constant-time `compare_digest`.
- **Replay protection**:
  - A one-time `state` is generated by `GET /api/v1/auths/telegram/state`.
  - The `state` is stored in the session cookie (`owui-session`) and is **burned on any attempt** (success or failure).
- **Time window enforcement**:
  - `auth_date` must be recent (default max age `600s`).
  - Max age is clamped to a safe range (`60s` to `24h`) and includes a small future-skew guard.
- **Rate limiting** (per client IP):
  - `state`: 60 requests / 10 minutes
  - `signin|signup|link|unlink`: 15 requests / 3 minutes
  - If Redis is unavailable, rate limiting falls back to in-memory storage.
- **Audit logging**:
  - Logs action + outcome + IP (+ user_id/telegram_id when available).
  - Sensitive config values (tokens/secrets) are redacted in config logging paths.

## Common failure modes & troubleshooting

### Telegram widget not visible on `/auth`

- Check `GET /api/config` → `telegram.enabled` is `true`.
- Ensure `ENABLE_TELEGRAM_AUTH=true`, and both `TELEGRAM_BOT_USERNAME` + `TELEGRAM_BOT_TOKEN` are set.
- Verify the backend process/container was restarted after changing env vars.

### `NOT_LINKED` on sign-in

Expected by design when Telegram is not linked:
- Sign in using your existing auth method, then link Telegram in **Settings → Account**.

### `SIGNUP_DISABLED` on sign-up

Enable sign-up explicitly:
- Set `ENABLE_TELEGRAM_SIGNUP=true` and restart.

### `INVALID_SIGNATURE` / `auth_date` errors

- Confirm you are using the correct `TELEGRAM_BOT_TOKEN` for the bot in `TELEGRAM_BOT_USERNAME`.
- Ensure server time is accurate (NTP). Large clock skew can cause expiry failures.
- If your users are routinely failing due to delays, increase `TELEGRAM_AUTH_MAX_AGE_SECONDS` (within reason).

### State errors (invalid/expired)

If the API rejects state:
- Reload the page and retry (state is one-time and short-lived).
- Make sure cookies are enabled and `Set-Cookie` is not stripped by your proxy.
- If using separate frontend/backends (CORS), ensure session cookie settings (SameSite/Secure) are correct.

### Rate limiting (`429`)

- Wait a few minutes and retry.
- If many users share one IP (NAT), you may see false positives; adjust the limiter settings in `backend/open_webui/routers/auths.py`.

### CSP blocks Telegram widget script/iframe

Open WebUI sets `Content-Security-Policy` only if you provide `CONTENT_SECURITY_POLICY`.
If you use CSP, allow the Telegram Login Widget:

- Add `https://telegram.org` to `script-src`
- Add `https://oauth.telegram.org` to `frame-src` (or `child-src`, depending on your CSP)

Example (minimal; adapt to your policy):

```text
CONTENT_SECURITY_POLICY="default-src 'self'; script-src 'self' https://telegram.org; frame-src 'self' https://oauth.telegram.org; ..."
```

## Recommendations for multi-provider auth

- Prefer **linking** Telegram to an existing account rather than enabling Telegram sign-up.
- If you enable Telegram sign-up, decide how you want to handle account duplication and whether you want admins to merge accounts (Open WebUI does not automatically merge users across providers).
