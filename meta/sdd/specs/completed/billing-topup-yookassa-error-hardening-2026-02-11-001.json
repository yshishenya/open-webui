{
  "spec_id": "billing-topup-yookassa-error-hardening-2026-02-11-001",
  "title": "YooKassa top-up error hardening and visibility",
  "generated": "2026-02-11T00:00:00Z",
  "last_updated": "2026-02-11T10:56:05.202905Z",
  "metadata": {
    "title": "YooKassa top-up error hardening and visibility",
    "description": "Normalize provider failures for billing top-up and surface actionable messages to users/operators.",
    "objectives": [
      "Make billing top-up failures actionable and observable.",
      "Map YooKassa provider failures to stable user-safe API details.",
      "Surface backend detail in UI toast instead of generic fallback."
    ],
    "complexity": "medium",
    "owner": "Codex",
    "status": "completed",
    "work_item_spec": "meta/memory_bank/specs/work_items/2026-02-11__bugfix__billing-topup-yookassa-error-visibility.md",
    "assumptions": [
      "YooKassa credentials and webhook config are managed via environment variables.",
      "Top-up packages and currency policy remain unchanged.",
      "Changes should keep upstream diffs minimal and avoid contract breakage."
    ],
    "activated_date": "2026-02-11T10:32:23.641763Z",
    "progress_percentage": 96,
    "current_phase": "phase-4",
    "completed_date": "2026-02-11T10:56:05.202446Z",
    "actual_hours": 0.004
  },
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "YooKassa top-up error hardening and visibility",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4"
      ],
      "total_tasks": 29,
      "completed_tasks": 28,
      "metadata": {
        "work_item_spec": "meta/memory_bank/specs/work_items/2026-02-11__bugfix__billing-topup-yookassa-error-visibility.md",
        "scope": "backend billing router/client + billing balance frontend + ops docs"
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Failure modes and API contract baseline",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "phase-1-files",
        "phase-1-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 5,
      "metadata": {
        "purpose": "Fix scope and explicitly define provider failure-to-detail mapping before implementation.",
        "risk_level": "low",
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:46:11.714441Z",
        "journaled_at": "2026-02-11T10:46:11.722392Z"
      }
    },
    "phase-1-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "completed",
      "parent": "phase-1",
      "children": [
        "task-1-1",
        "task-1-2"
      ],
      "dependencies": {
        "blocks": [
          "phase-1-verify"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:43:29.940422Z",
        "journaled_at": "2026-02-11T10:43:29.945258Z"
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Investigate existing top-up failure surfaces",
      "status": "completed",
      "parent": "phase-1-files",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "investigation",
        "estimated_hours": 1,
        "details": [
          "Trace error path from YooKassa client to /billing/topup response.",
          "List current generic error points in backend and frontend."
        ],
        "started_at": "2026-02-11T10:42:03.797841Z",
        "status_note": "Investigation completed",
        "completed_at": "2026-02-11T10:42:19.689663Z",
        "needs_journaling": false,
        "actual_hours": 0.004,
        "journaled_at": "2026-02-11T10:42:19.692581Z"
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Document normalized error contract in work item spec",
      "status": "completed",
      "parent": "phase-1-files",
      "children": [
        "task-1-2-1",
        "task-1-2-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-1-1"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "task_category": "decision",
        "estimated_hours": 1
      }
    },
    "task-1-2-1": {
      "type": "subtask",
      "title": "Define provider status -> API detail mapping",
      "status": "completed",
      "parent": "task-1-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "decision",
        "started_at": "2026-02-11T10:42:38.022539Z",
        "status_note": "Provider status mapping documented",
        "completed_at": "2026-02-11T10:42:57.136759Z",
        "needs_journaling": false,
        "actual_hours": 0.005,
        "journaled_at": "2026-02-11T10:42:57.140234Z"
      }
    },
    "task-1-2-2": {
      "type": "subtask",
      "title": "Define user-safe logging and message constraints",
      "status": "completed",
      "parent": "task-1-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "decision",
        "started_at": "2026-02-11T10:43:11.889558Z",
        "status_note": "User-safe constraints documented",
        "completed_at": "2026-02-11T10:43:29.940128Z",
        "needs_journaling": false,
        "actual_hours": 0.005,
        "journaled_at": "2026-02-11T10:43:29.943089Z"
      }
    },
    "phase-1-verify": {
      "type": "group",
      "title": "Verification",
      "status": "completed",
      "parent": "phase-1",
      "children": [
        "verify-1-1",
        "verify-1-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-1-files"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:46:11.714437Z",
        "journaled_at": "2026-02-11T10:46:11.720980Z"
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Error contract matrix reviewed",
      "status": "completed",
      "parent": "phase-1-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "manual",
        "command": "Review work item spec mapping table for 400/401/403/429/network/unexpected errors.",
        "expected": "Mapping is explicit and user-safe.",
        "started_at": "2026-02-11T10:43:47.238819Z",
        "status_note": "Manual contract review passed",
        "completed_at": "2026-02-11T10:43:56.274498Z",
        "needs_journaling": false,
        "actual_hours": 0.003,
        "journaled_at": "2026-02-11T10:43:56.277648Z"
      }
    },
    "verify-1-2": {
      "type": "verify",
      "title": "Phase 1 fidelity review",
      "status": "completed",
      "parent": "phase-1-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "fidelity",
        "agent": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-1",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "started_at": "2026-02-11T10:44:16.335519Z",
        "status_note": "Phase-1 fidelity verification completed",
        "completed_at": "2026-02-11T10:46:11.714224Z",
        "needs_journaling": false,
        "actual_hours": 0.032,
        "journaled_at": "2026-02-11T10:46:11.717943Z"
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Backend provider error normalization",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "phase-2-files",
        "phase-2-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      },
      "total_tasks": 9,
      "completed_tasks": 9,
      "metadata": {
        "purpose": "Introduce typed YooKassa request errors and stable HTTP mapping in billing endpoints.",
        "risk_level": "medium",
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:51:49.710867Z",
        "journaled_at": "2026-02-11T10:51:49.716188Z"
      }
    },
    "phase-2-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "completed",
      "parent": "phase-2",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3"
      ],
      "dependencies": {
        "blocks": [
          "phase-2-verify"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 6,
      "completed_tasks": 6,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:51:35.527980Z",
        "journaled_at": "2026-02-11T10:51:35.532074Z"
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "backend/open_webui/utils/yookassa.py",
      "status": "completed",
      "parent": "phase-2-files",
      "children": [
        "task-2-1-1",
        "task-2-1-2"
      ],
      "dependencies": {
        "blocks": [
          "task-2-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "backend/open_webui/utils/yookassa.py",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-2-1-1": {
      "type": "subtask",
      "title": "Add typed YooKassaRequestError with status and response payload",
      "status": "completed",
      "parent": "task-2-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:34.611156Z",
        "needs_journaling": false,
        "status_note": "Implemented and verified in this worktree",
        "journaled_at": "2026-02-11T10:51:34.613281Z"
      }
    },
    "task-2-1-2": {
      "type": "subtask",
      "title": "Wrap network and unexpected errors into typed provider exception",
      "status": "completed",
      "parent": "task-2-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:46:32.802064Z",
        "needs_journaling": true,
        "status_note": "Network/unexpected wrapping implemented"
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "backend/open_webui/routers/billing.py",
      "status": "completed",
      "parent": "phase-2-files",
      "children": [
        "task-2-2-1",
        "task-2-2-2"
      ],
      "dependencies": {
        "blocks": [
          "task-2-3"
        ],
        "blocked_by": [
          "task-2-1"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "backend/open_webui/routers/billing.py",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-2-2-1": {
      "type": "subtask",
      "title": "Map provider errors to stable 502 details for /billing/topup",
      "status": "completed",
      "parent": "task-2-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:34.845390Z",
        "needs_journaling": false,
        "status_note": "Implemented and verified in this worktree",
        "journaled_at": "2026-02-11T10:51:34.847353Z"
      }
    },
    "task-2-2-2": {
      "type": "subtask",
      "title": "Apply same mapping to /billing/payment with user-safe logs",
      "status": "completed",
      "parent": "task-2-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:35.080142Z",
        "needs_journaling": false,
        "status_note": "Implemented and verified in this worktree",
        "journaled_at": "2026-02-11T10:51:35.081936Z"
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "backend/open_webui/test/apps/webui/routers/test_billing_topup.py",
      "status": "completed",
      "parent": "phase-2-files",
      "children": [
        "task-2-3-1",
        "task-2-3-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-2-2"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "backend/open_webui/test/apps/webui/routers/test_billing_topup.py",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-2-3-1": {
      "type": "subtask",
      "title": "Add regression tests for provider auth and bad request mappings",
      "status": "completed",
      "parent": "task-2-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:35.296547Z",
        "needs_journaling": false,
        "status_note": "Implemented and verified in this worktree",
        "journaled_at": "2026-02-11T10:51:35.298288Z"
      }
    },
    "task-2-3-2": {
      "type": "subtask",
      "title": "Keep invalid amount validation behavior intact",
      "status": "completed",
      "parent": "task-2-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:35.527684Z",
        "needs_journaling": false,
        "status_note": "Implemented and verified in this worktree",
        "journaled_at": "2026-02-11T10:51:35.529619Z"
      }
    },
    "phase-2-verify": {
      "type": "group",
      "title": "Verification",
      "status": "completed",
      "parent": "phase-2",
      "children": [
        "verify-2-1",
        "verify-2-2",
        "verify-2-3"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-2-files"
        ],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:51:49.710861Z",
        "journaled_at": "2026-02-11T10:51:49.715083Z"
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Backend top-up router tests pass",
      "status": "completed",
      "parent": "phase-2-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "docker compose -f docker-compose.yaml -f docker-compose.dev.yaml run --rm airis bash -lc \"pytest -q open_webui/test/apps/webui/routers/test_billing_topup.py\"",
        "expected": "All top-up tests pass with new error mapping coverage",
        "completed_at": "2026-02-11T10:51:49.244597Z",
        "needs_journaling": false,
        "status_note": "docker compose backend pytest passed (12 passed)",
        "journaled_at": "2026-02-11T10:51:49.246511Z"
      }
    },
    "verify-2-2": {
      "type": "verify",
      "title": "Backend lint passes on touched files",
      "status": "completed",
      "parent": "phase-2-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "docker compose -f docker-compose.yaml -f docker-compose.dev.yaml -f .codex/docker-compose.codex.yaml run --rm --no-deps pytools \"python -m pip install -U pip >/dev/null && python -m pip install -q 'ruff>=0.1' && ruff check backend/open_webui/routers/billing.py backend/open_webui/utils/yookassa.py backend/open_webui/test/apps/webui/routers/test_billing_topup.py\"",
        "expected": "Ruff returns no issues",
        "completed_at": "2026-02-11T10:51:49.472018Z",
        "needs_journaling": false,
        "status_note": "docker compose pytools ruff check passed",
        "journaled_at": "2026-02-11T10:51:49.474220Z"
      }
    },
    "verify-2-3": {
      "type": "verify",
      "title": "Phase 2 fidelity review",
      "status": "completed",
      "parent": "phase-2-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "fidelity",
        "agent": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-2",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "completed_at": "2026-02-11T10:51:49.710603Z",
        "needs_journaling": false,
        "status_note": "Fidelity review run in no-AI mode for phase-2; no blocking deviations identified",
        "journaled_at": "2026-02-11T10:51:49.712761Z"
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Frontend error surfacing and localization",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "phase-3-files",
        "phase-3-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      },
      "total_tasks": 9,
      "completed_tasks": 9,
      "metadata": {
        "purpose": "Display API detail in top-up flow and localize provider-level error messages.",
        "risk_level": "low",
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:52:08.692559Z",
        "journaled_at": "2026-02-11T10:52:08.698795Z"
      }
    },
    "phase-3-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "completed",
      "parent": "phase-3",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4"
      ],
      "dependencies": {
        "blocks": [
          "phase-3-verify"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 6,
      "completed_tasks": 6,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:51:56.354079Z",
        "journaled_at": "2026-02-11T10:51:56.358586Z"
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "src/routes/(app)/billing/balance/+page.svelte",
      "status": "completed",
      "parent": "phase-3-files",
      "children": [
        "task-3-1-1",
        "task-3-1-2"
      ],
      "dependencies": {
        "blocks": [
          "task-3-4"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "src/routes/(app)/billing/balance/+page.svelte",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-3-1-1": {
      "type": "subtask",
      "title": "Extract API detail from top-up failure payload",
      "status": "completed",
      "parent": "task-3-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:55.212723Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:55.214555Z"
      }
    },
    "task-3-1-2": {
      "type": "subtask",
      "title": "Show detail-aware toast with fallback to generic message",
      "status": "completed",
      "parent": "task-3-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:55.438168Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:55.440056Z"
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "src/lib/i18n/locales/en-US/translation.json",
      "status": "completed",
      "parent": "phase-3-files",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "file_path": "src/lib/i18n/locales/en-US/translation.json",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "completed_at": "2026-02-11T10:51:55.669873Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:55.671740Z"
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "src/lib/i18n/locales/ru-RU/translation.json",
      "status": "completed",
      "parent": "phase-3-files",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "file_path": "src/lib/i18n/locales/ru-RU/translation.json",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "completed_at": "2026-02-11T10:51:55.902665Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:55.904669Z"
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "src/routes/(app)/billing/balance/billing-balance.test.ts",
      "status": "completed",
      "parent": "phase-3-files",
      "children": [
        "task-3-4-1",
        "task-3-4-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-3-1"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "src/routes/(app)/billing/balance/billing-balance.test.ts",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-3-4-1": {
      "type": "subtask",
      "title": "Add regression test for detail-aware error toast",
      "status": "completed",
      "parent": "task-3-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:56.131790Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:56.133777Z"
      }
    },
    "task-3-4-2": {
      "type": "subtask",
      "title": "Reset toast/topup mocks in beforeEach to prevent cross-test bleed",
      "status": "completed",
      "parent": "task-3-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:51:56.353829Z",
        "needs_journaling": false,
        "status_note": "Implemented and covered by frontend regression tests",
        "journaled_at": "2026-02-11T10:51:56.355753Z"
      }
    },
    "phase-3-verify": {
      "type": "group",
      "title": "Verification",
      "status": "completed",
      "parent": "phase-3",
      "children": [
        "verify-3-1",
        "verify-3-2",
        "verify-3-3"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3-files"
        ],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:52:08.692551Z",
        "journaled_at": "2026-02-11T10:52:08.697535Z"
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Frontend billing balance tests pass",
      "status": "completed",
      "parent": "phase-3-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "docker compose -f docker-compose.yaml -f docker-compose.dev.yaml run --rm --no-deps airis-frontend sh -lc \"npm run test:frontend -- --run src/routes/\\(app\\)/billing/balance/billing-balance.test.ts\"",
        "expected": "Vitest suite passes",
        "completed_at": "2026-02-11T10:52:08.239417Z",
        "needs_journaling": false,
        "status_note": "docker compose frontend vitest passed (billing-balance.test.ts)",
        "journaled_at": "2026-02-11T10:52:08.241454Z"
      }
    },
    "verify-3-2": {
      "type": "verify",
      "title": "Frontend lint passes on touched balance files",
      "status": "completed",
      "parent": "phase-3-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "docker compose -f docker-compose.yaml -f docker-compose.dev.yaml run --rm --no-deps airis-frontend sh -lc \"npx eslint src/routes/\\(app\\)/billing/balance/+page.svelte src/routes/\\(app\\)/billing/balance/billing-balance.test.ts\"",
        "expected": "ESLint returns no errors",
        "completed_at": "2026-02-11T10:52:08.465248Z",
        "needs_journaling": false,
        "status_note": "docker compose frontend eslint passed on touched balance files",
        "journaled_at": "2026-02-11T10:52:08.467274Z"
      }
    },
    "verify-3-3": {
      "type": "verify",
      "title": "Phase 3 fidelity review",
      "status": "completed",
      "parent": "phase-3-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "fidelity",
        "agent": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-3",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "completed_at": "2026-02-11T10:52:08.692252Z",
        "needs_journaling": false,
        "status_note": "Fidelity review run in no-AI mode for phase-3; no blocking deviations identified",
        "journaled_at": "2026-02-11T10:52:08.694604Z"
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Ops readiness and rollout verification",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "phase-4-files",
        "phase-4-verify"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      },
      "total_tasks": 6,
      "completed_tasks": 5,
      "metadata": {
        "purpose": "Capture troubleshooting guidance and confirm deployment-time behavior.",
        "risk_level": "medium"
      }
    },
    "phase-4-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "completed",
      "parent": "phase-4",
      "children": [
        "task-4-1",
        "task-4-2"
      ],
      "dependencies": {
        "blocks": [
          "phase-4-verify"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "needs_journaling": false,
        "completed_at": "2026-02-11T10:52:15.366154Z",
        "journaled_at": "2026-02-11T10:52:15.371590Z"
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "meta/docs/reference/b2c_implementation.md",
      "status": "completed",
      "parent": "phase-4-files",
      "children": [
        "task-4-1-1",
        "task-4-1-2"
      ],
      "total_tasks": 2,
      "completed_tasks": 2,
      "metadata": {
        "file_path": "meta/docs/reference/b2c_implementation.md",
        "task_category": "implementation",
        "estimated_hours": 1
      }
    },
    "task-4-1-1": {
      "type": "subtask",
      "title": "Add troubleshooting notes for top-up provider errors",
      "status": "completed",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:52:14.915040Z",
        "needs_journaling": false,
        "status_note": "Added YooKassa top-up troubleshooting mapping to b2c implementation reference",
        "journaled_at": "2026-02-11T10:52:14.917238Z"
      }
    },
    "task-4-1-2": {
      "type": "subtask",
      "title": "Add smoke checklist for wallet top-up in configured env",
      "status": "completed",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "completed_at": "2026-02-11T10:52:15.144352Z",
        "needs_journaling": false,
        "status_note": "Added wallet top-up smoke checklist items for actionable error messages",
        "journaled_at": "2026-02-11T10:52:15.146387Z"
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "meta/memory_bank/specs/work_items/2026-02-11__bugfix__billing-topup-yookassa-error-visibility.md",
      "status": "completed",
      "parent": "phase-4-files",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "file_path": "meta/memory_bank/specs/work_items/2026-02-11__bugfix__billing-topup-yookassa-error-visibility.md",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "details": "Update rollout/verification section after final smoke results.",
        "completed_at": "2026-02-11T10:52:15.365864Z",
        "needs_journaling": false,
        "status_note": "Updated work item spec with active SDD link and rollout verification status",
        "journaled_at": "2026-02-11T10:52:15.368465Z"
      }
    },
    "phase-4-verify": {
      "type": "group",
      "title": "Verification",
      "status": "in_progress",
      "parent": "phase-4",
      "children": [
        "verify-4-1",
        "verify-4-2",
        "verify-4-3"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-4-files"
        ],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 2,
      "metadata": {}
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Manual smoke: top-up shows actionable provider message",
      "status": "blocked",
      "parent": "phase-4-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "Trigger top-up failure in staging/dev with misconfigured YooKassa credential and verify localized actionable toast.",
        "expected": "User sees concrete provider reason instead of generic top-up failure text",
        "blocked_at": "2026-02-11T10:55:33.101062Z",
        "blocker_type": "resource",
        "blocker_description": "Manual smoke requires configured dev/staging YooKassa credentials to trigger provider-side failures; unavailable in this environment",
        "blocked_by_external": true
      }
    },
    "verify-4-2": {
      "type": "verify",
      "title": "Python compile sanity for touched backend files",
      "status": "completed",
      "parent": "phase-4-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "python -m py_compile backend/open_webui/utils/yookassa.py backend/open_webui/routers/billing.py backend/open_webui/test/apps/webui/routers/test_billing_topup.py",
        "expected": "No syntax/type import errors during compilation",
        "completed_at": "2026-02-11T10:55:32.822160Z",
        "needs_journaling": false,
        "status_note": "python -m py_compile passed for touched backend files",
        "journaled_at": "2026-02-11T10:55:32.825483Z"
      }
    },
    "verify-4-3": {
      "type": "verify",
      "title": "Full spec fidelity review",
      "status": "completed",
      "parent": "phase-4-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "fidelity",
        "agent": "sdd-fidelity-review",
        "scope": "spec",
        "target": "spec-root",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "completed_at": "2026-02-11T10:55:33.350834Z",
        "needs_journaling": false,
        "status_note": "Full fidelity review executed in no-AI mode; AI multi-tool attempt was terminated after hang; no blocking deviations found in implemented scope",
        "journaled_at": "2026-02-11T10:55:33.353252Z"
      }
    }
  },
  "journal": [
    {
      "timestamp": "2026-02-11T10:42:19.692576Z",
      "entry_type": "decision",
      "title": "Investigated top-up failure surfaces",
      "author": "claude-code",
      "content": "Traced failure path end-to-end: YooKassa client request failures originate in backend/open_webui/utils/yookassa.py and are mapped in backend/open_webui/routers/billing.py for /billing/topup and /billing/payment. Confirmed old failure symptom: generic 'Failed to create topup' remained possible via catch-all path and frontend fallback. Confirmed UI now extracts API detail in src/routes/(app)/billing/balance/+page.svelte and falls back only when detail is missing. No additional code changes were required for this investigation task.",
      "metadata": {},
      "task_id": "task-1-1"
    },
    {
      "timestamp": "2026-02-11T10:42:57.140226Z",
      "entry_type": "decision",
      "title": "Defined provider status-to-detail mapping",
      "author": "claude-code",
      "content": "Updated work item spec with normalized provider error contract table mapping YooKassa status signals to API status/detail. Captured mappings for 401/403, 400, 429, >=500/unexpected, runtime client init failures, and preserved 400 validation behavior for invalid top-up inputs.",
      "metadata": {},
      "task_id": "task-1-2-1"
    },
    {
      "timestamp": "2026-02-11T10:43:29.943085Z",
      "entry_type": "decision",
      "title": "Defined user-safe logging and messaging constraints",
      "author": "claude-code",
      "content": "Added explicit constraints to work item spec: API detail must remain deterministic and user-safe, raw provider payloads stay in backend logs only, frontend prefers backend detail with generic fallback, and validation text behavior remains unchanged.",
      "metadata": {},
      "task_id": "task-1-2-2"
    },
    {
      "timestamp": "2026-02-11T10:43:29.945254Z",
      "entry_type": "status_change",
      "title": "Group Completed: File Modifications",
      "author": "claude-code",
      "content": "All child tasks in group phase-1-files have been completed.",
      "metadata": {},
      "task_id": "phase-1-files"
    },
    {
      "timestamp": "2026-02-11T10:43:56.277643Z",
      "entry_type": "note",
      "title": "Reviewed phase-1 contract matrix",
      "author": "claude-code",
      "content": "Verified the work item spec contains explicit provider mapping for 400/401/403/429 and fallback temporary-unavailable path, plus user-safe logging/message constraints. Contract is deterministic and avoids raw provider payload leakage to end users.",
      "metadata": {},
      "task_id": "verify-1-1"
    },
    {
      "timestamp": "2026-02-11T10:46:11.717933Z",
      "entry_type": "note",
      "title": "Completed phase-1 fidelity verification",
      "author": "claude-code",
      "content": "Executed fidelity-review workflow for phase-1 and validated implementation against spec requirements. Confirmed investigation and contract documentation deliverables are present and aligned with acceptance criteria. No blocking deviations identified for phase-1 scope.",
      "metadata": {},
      "task_id": "verify-1-2"
    },
    {
      "timestamp": "2026-02-11T10:46:11.720973Z",
      "entry_type": "status_change",
      "title": "Group Completed: Verification",
      "author": "claude-code",
      "content": "All child tasks in group phase-1-verify have been completed.",
      "metadata": {},
      "task_id": "phase-1-verify"
    },
    {
      "timestamp": "2026-02-11T10:46:11.722387Z",
      "entry_type": "status_change",
      "title": "Phase Completed: Failure modes and API contract baseline",
      "author": "claude-code",
      "content": "All child tasks in phase phase-1 have been completed.",
      "metadata": {},
      "task_id": "phase-1"
    },
    {
      "timestamp": "2026-02-11T10:46:32.803990Z",
      "entry_type": "decision",
      "title": "Added typed YooKassaRequestError",
      "author": "claude-code",
      "content": "Implemented YooKassaRequestError in backend/open_webui/utils/yookassa.py with status_code and response_text fields to preserve provider-level diagnostics for upper-layer mapping.",
      "metadata": {},
      "task_id": "task-2-1-1"
    },
    {
      "timestamp": "2026-02-11T10:51:34.613276Z",
      "entry_type": "status_change",
      "title": "Task Completed: Add typed YooKassaRequestError with status and response payload",
      "author": "claude-code",
      "content": "Task task-2-1-1 marked as completed. \nNote: Implemented and verified in this worktree",
      "metadata": {},
      "task_id": "task-2-1-1"
    },
    {
      "timestamp": "2026-02-11T10:51:34.847346Z",
      "entry_type": "status_change",
      "title": "Task Completed: Map provider errors to stable 502 details for /billing/topup",
      "author": "claude-code",
      "content": "Task task-2-2-1 marked as completed. \nNote: Implemented and verified in this worktree",
      "metadata": {},
      "task_id": "task-2-2-1"
    },
    {
      "timestamp": "2026-02-11T10:51:35.081931Z",
      "entry_type": "status_change",
      "title": "Task Completed: Apply same mapping to /billing/payment with user-safe logs",
      "author": "claude-code",
      "content": "Task task-2-2-2 marked as completed. \nNote: Implemented and verified in this worktree",
      "metadata": {},
      "task_id": "task-2-2-2"
    },
    {
      "timestamp": "2026-02-11T10:51:35.298283Z",
      "entry_type": "status_change",
      "title": "Task Completed: Add regression tests for provider auth and bad request mappings",
      "author": "claude-code",
      "content": "Task task-2-3-1 marked as completed. \nNote: Implemented and verified in this worktree",
      "metadata": {},
      "task_id": "task-2-3-1"
    },
    {
      "timestamp": "2026-02-11T10:51:35.529614Z",
      "entry_type": "status_change",
      "title": "Task Completed: Keep invalid amount validation behavior intact",
      "author": "claude-code",
      "content": "Task task-2-3-2 marked as completed. \nNote: Implemented and verified in this worktree",
      "metadata": {},
      "task_id": "task-2-3-2"
    },
    {
      "timestamp": "2026-02-11T10:51:35.532056Z",
      "entry_type": "status_change",
      "title": "Group Completed: File Modifications",
      "author": "claude-code",
      "content": "All child tasks in group phase-2-files have been completed.",
      "metadata": {},
      "task_id": "phase-2-files"
    },
    {
      "timestamp": "2026-02-11T10:51:49.246505Z",
      "entry_type": "status_change",
      "title": "Task Completed: Backend top-up router tests pass",
      "author": "claude-code",
      "content": "Task verify-2-1 marked as completed. \nNote: docker compose backend pytest passed (12 passed)",
      "metadata": {},
      "task_id": "verify-2-1"
    },
    {
      "timestamp": "2026-02-11T10:51:49.474214Z",
      "entry_type": "status_change",
      "title": "Task Completed: Backend lint passes on touched files",
      "author": "claude-code",
      "content": "Task verify-2-2 marked as completed. \nNote: docker compose pytools ruff check passed",
      "metadata": {},
      "task_id": "verify-2-2"
    },
    {
      "timestamp": "2026-02-11T10:51:49.712752Z",
      "entry_type": "status_change",
      "title": "Task Completed: Phase 2 fidelity review",
      "author": "claude-code",
      "content": "Task verify-2-3 marked as completed. \nNote: Fidelity review run in no-AI mode for phase-2; no blocking deviations identified",
      "metadata": {},
      "task_id": "verify-2-3"
    },
    {
      "timestamp": "2026-02-11T10:51:49.715078Z",
      "entry_type": "status_change",
      "title": "Group Completed: Verification",
      "author": "claude-code",
      "content": "All child tasks in group phase-2-verify have been completed.",
      "metadata": {},
      "task_id": "phase-2-verify"
    },
    {
      "timestamp": "2026-02-11T10:51:49.716185Z",
      "entry_type": "status_change",
      "title": "Phase Completed: Backend provider error normalization",
      "author": "claude-code",
      "content": "All child tasks in phase phase-2 have been completed.",
      "metadata": {},
      "task_id": "phase-2"
    },
    {
      "timestamp": "2026-02-11T10:51:55.214550Z",
      "entry_type": "status_change",
      "title": "Task Completed: Extract API detail from top-up failure payload",
      "author": "claude-code",
      "content": "Task task-3-1-1 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-1-1"
    },
    {
      "timestamp": "2026-02-11T10:51:55.440051Z",
      "entry_type": "status_change",
      "title": "Task Completed: Show detail-aware toast with fallback to generic message",
      "author": "claude-code",
      "content": "Task task-3-1-2 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-1-2"
    },
    {
      "timestamp": "2026-02-11T10:51:55.671734Z",
      "entry_type": "status_change",
      "title": "Task Completed: src/lib/i18n/locales/en-US/translation.json",
      "author": "claude-code",
      "content": "Task task-3-2 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-2"
    },
    {
      "timestamp": "2026-02-11T10:51:55.904662Z",
      "entry_type": "status_change",
      "title": "Task Completed: src/lib/i18n/locales/ru-RU/translation.json",
      "author": "claude-code",
      "content": "Task task-3-3 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-3"
    },
    {
      "timestamp": "2026-02-11T10:51:56.133771Z",
      "entry_type": "status_change",
      "title": "Task Completed: Add regression test for detail-aware error toast",
      "author": "claude-code",
      "content": "Task task-3-4-1 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-4-1"
    },
    {
      "timestamp": "2026-02-11T10:51:56.355748Z",
      "entry_type": "status_change",
      "title": "Task Completed: Reset toast/topup mocks in beforeEach to prevent cross-test bleed",
      "author": "claude-code",
      "content": "Task task-3-4-2 marked as completed. \nNote: Implemented and covered by frontend regression tests",
      "metadata": {},
      "task_id": "task-3-4-2"
    },
    {
      "timestamp": "2026-02-11T10:51:56.358576Z",
      "entry_type": "status_change",
      "title": "Group Completed: File Modifications",
      "author": "claude-code",
      "content": "All child tasks in group phase-3-files have been completed.",
      "metadata": {},
      "task_id": "phase-3-files"
    },
    {
      "timestamp": "2026-02-11T10:52:08.241448Z",
      "entry_type": "status_change",
      "title": "Task Completed: Frontend billing balance tests pass",
      "author": "claude-code",
      "content": "Task verify-3-1 marked as completed. \nNote: docker compose frontend vitest passed (billing-balance.test.ts)",
      "metadata": {},
      "task_id": "verify-3-1"
    },
    {
      "timestamp": "2026-02-11T10:52:08.467266Z",
      "entry_type": "status_change",
      "title": "Task Completed: Frontend lint passes on touched balance files",
      "author": "claude-code",
      "content": "Task verify-3-2 marked as completed. \nNote: docker compose frontend eslint passed on touched balance files",
      "metadata": {},
      "task_id": "verify-3-2"
    },
    {
      "timestamp": "2026-02-11T10:52:08.694598Z",
      "entry_type": "status_change",
      "title": "Task Completed: Phase 3 fidelity review",
      "author": "claude-code",
      "content": "Task verify-3-3 marked as completed. \nNote: Fidelity review run in no-AI mode for phase-3; no blocking deviations identified",
      "metadata": {},
      "task_id": "verify-3-3"
    },
    {
      "timestamp": "2026-02-11T10:52:08.697530Z",
      "entry_type": "status_change",
      "title": "Group Completed: Verification",
      "author": "claude-code",
      "content": "All child tasks in group phase-3-verify have been completed.",
      "metadata": {},
      "task_id": "phase-3-verify"
    },
    {
      "timestamp": "2026-02-11T10:52:08.698790Z",
      "entry_type": "status_change",
      "title": "Phase Completed: Frontend error surfacing and localization",
      "author": "claude-code",
      "content": "All child tasks in phase phase-3 have been completed.",
      "metadata": {},
      "task_id": "phase-3"
    },
    {
      "timestamp": "2026-02-11T10:52:14.917230Z",
      "entry_type": "status_change",
      "title": "Task Completed: Add troubleshooting notes for top-up provider errors",
      "author": "claude-code",
      "content": "Task task-4-1-1 marked as completed. \nNote: Added YooKassa top-up troubleshooting mapping to b2c implementation reference",
      "metadata": {},
      "task_id": "task-4-1-1"
    },
    {
      "timestamp": "2026-02-11T10:52:15.146382Z",
      "entry_type": "status_change",
      "title": "Task Completed: Add smoke checklist for wallet top-up in configured env",
      "author": "claude-code",
      "content": "Task task-4-1-2 marked as completed. \nNote: Added wallet top-up smoke checklist items for actionable error messages",
      "metadata": {},
      "task_id": "task-4-1-2"
    },
    {
      "timestamp": "2026-02-11T10:52:15.368458Z",
      "entry_type": "status_change",
      "title": "Task Completed: meta/memory_bank/specs/work_items/2026-02-11__bugfix__billing-topup-yookassa-error-visibility.md",
      "author": "claude-code",
      "content": "Task task-4-2 marked as completed. \nNote: Updated work item spec with active SDD link and rollout verification status",
      "metadata": {},
      "task_id": "task-4-2"
    },
    {
      "timestamp": "2026-02-11T10:52:15.371583Z",
      "entry_type": "status_change",
      "title": "Group Completed: File Modifications",
      "author": "claude-code",
      "content": "All child tasks in group phase-4-files have been completed.",
      "metadata": {},
      "task_id": "phase-4-files"
    },
    {
      "timestamp": "2026-02-11T10:55:32.825461Z",
      "entry_type": "status_change",
      "title": "Task Completed: Python compile sanity for touched backend files",
      "author": "claude-code",
      "content": "Task verify-4-2 marked as completed. \nNote: python -m py_compile passed for touched backend files",
      "metadata": {},
      "task_id": "verify-4-2"
    },
    {
      "timestamp": "2026-02-11T10:55:33.353245Z",
      "entry_type": "status_change",
      "title": "Task Completed: Full spec fidelity review",
      "author": "claude-code",
      "content": "Task verify-4-3 marked as completed. \nNote: Full fidelity review executed in no-AI mode; AI multi-tool attempt was terminated after hang; no blocking deviations found in implemented scope",
      "metadata": {},
      "task_id": "verify-4-3"
    }
  ]
}