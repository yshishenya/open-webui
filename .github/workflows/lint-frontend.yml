name: Bun CI

on:
  push:
    branches: ['main']
  pull_request:

permissions:
  contents: read

jobs:
  build:
    name: 'Lint Frontend'
    runs-on: ubuntu-latest
    env:
      PUBLIC_API_BASE_URL: ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect changed frontend lint targets
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          mapfile -t files < <(
            git diff --name-only --diff-filter=ACMR "$BASE_SHA" "$GITHUB_SHA" \
              | grep -E '^(src/.*\.(svelte|ts|js|mjs|cjs)|src/app\.d\.ts|(eslint|vite|svelte|postcss|tailwind)\.config\.(js|ts|mjs|cjs))$' || true
          )

          if [ "${#files[@]}" -eq 0 ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_files=true" >> "$GITHUB_OUTPUT"
          {
            echo "files<<EOF"
            printf '%s\n' "${files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Skip frontend lint when no lintable frontend files changed
        if: steps.changed.outputs.has_files != 'true'
        run: echo "No frontend lint targets changed."

      - name: Use Bun
        if: steps.changed.outputs.has_files == 'true'
        uses: oven-sh/setup-bun@v1

      - name: Install frontend dependencies
        if: steps.changed.outputs.has_files == 'true'
        run: bun install --frozen-lockfile

      - name: Lint changed frontend files
        if: steps.changed.outputs.has_files == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FILES < <(printf '%s\n' "${{ steps.changed.outputs.files }}" | sed '/^$/d')
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No frontend lint targets detected after normalization."
            exit 0
          fi
          printf '%s\0' "${FILES[@]}" | xargs -0 bunx eslint
